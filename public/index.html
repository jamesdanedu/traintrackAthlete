<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrainTrack - Athlete</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="TrainTrack - Professional athlete training assessments">
    <meta name="theme-color" content="#2a9d8f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TrainTrack">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        :root {
            --primary-color: #2a9d8f;
            --primary-dark: #238a7c;
            --secondary-color: #4a90e2;
            --success-color: #5cb85c;
            --danger-color: #e74c3c;
        }
        
        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }
        
        .login-header {
            text-align: center;
            padding: 60px 20px 40px;
            color: white;
        }
        
        .app-logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            backdrop-filter: blur(20px);
            font-size: 32px;
        }
        
        .login-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .login-form {
            background: white;
            margin: 20px;
            border-radius: 20px;
            padding: 32px;
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: #fafbfc;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.1);
        }
        
        .login-button {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }
        
        .login-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(42, 157, 143, 0.3);
        }
        
        .login-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 16px;
            border: 1px solid rgba(231, 76, 60, 0.2);
            display: none;
        }
        
        .success-message {
            background: rgba(92, 184, 92, 0.1);
            color: var(--success-color);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 16px;
            border: 1px solid rgba(92, 184, 92, 0.2);
            display: none;
        }
        
        /* Assessment App Styles */
        .assessment-app {
            display: none;
            padding-bottom: 70px;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .logout-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }
        
        .app-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .session-info {
            background: linear-gradient(135deg, #f8f9fa 0%, white 100%);
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .athlete-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin-bottom: 4px;
        }
        
        .team-info {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .session-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .detail-item {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .detail-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .tab-container {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab-button {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .assessment-content {
            display: none;
        }
        
        .assessment-content.active {
            display: block;
        }
        
        .assessment-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .assessment-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .assessment-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .step-progress {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }
        
        .form-section {
            padding: 20px;
            padding-bottom: 100px;
            display: none;
        }
        
        .form-section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 32px;
        }
        
        .form-label {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }
        
        .required {
            color: var(--danger-color);
        }
        
        .form-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        .slider-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .slider-value {
            text-align: center;
            margin-bottom: 8px;
        }
        
        .slider-value-display {
            background: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 600;
            min-width: 60px;
            display: inline-block;
        }
        
        .slider-description {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .slider-input {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            appearance: none;
        }
        
        .slider-input::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(42, 157, 143, 0.3);
        }
        
        .slider-input::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(42, 157, 143, 0.3);
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #999;
        }
        
        .form-select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        
        .checkbox-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .checkbox-item:hover {
            border-color: var(--primary-color);
        }
        
        .checkbox-item.selected {
            background: rgba(42, 157, 143, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .fab-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-width: 360px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            z-index: 1000;
        }
        
        .nav-button {
            flex: 1;
            height: 48px;
            border-radius: 24px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .nav-button.show {
            display: flex;
        }
        
        .nav-button.secondary {
            background: white;
            color: #666;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .nav-button.primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(42, 157, 143, 0.3);
        }
        
        .nav-button.success {
            background: var(--success-color);
            color: white;
            box-shadow: 0 2px 8px rgba(92, 184, 92, 0.3);
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
        }
        
        @media (min-width: 768px) {
            .app-container {
                max-width: 768px;
            }
            
            .fab-container {
                max-width: 728px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div>
                <div class="spinner"></div>
                <p style="margin-top: 16px; color: #666;">Loading...</p>
            </div>
        </div>
        
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <div class="login-header">
                <div class="app-logo">🏃</div>
                <h1 class="login-title">TrainTrack</h1>
                <p class="login-subtitle">Athlete Performance Monitoring</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        placeholder="your.email@example.com"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="form-input" 
                        placeholder="Enter your password"
                        required
                    >
                </div>
                
                <button type="submit" class="login-button" id="loginButton">
                    Sign In
                </button>
                
                <div id="loginError" class="error-message"></div>
                <div id="loginSuccess" class="success-message"></div>
            </form>
        </div>
        
        <!-- Assessment App -->
        <div class="assessment-app" id="assessmentApp">
            <!-- App Header -->
            <div class="app-header">
                <div class="app-title">TrainTrack Assessments</div>
                <button class="logout-btn" onclick="logout()">↗</button>
            </div>
            
            <!-- Session Info -->
            <div class="session-info">
                <div class="athlete-name" id="athleteName">Loading...</div>
                <div class="team-info" id="teamInfo">Loading team information...</div>
                <div class="session-details">
                    <div class="detail-item">
                        <div class="detail-label">Last Assessment</div>
                        <div class="detail-value" id="lastAssessment">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Weekly Sessions</div>
                        <div class="detail-value" id="weeklySessions">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-container">
                <button class="tab-button active" onclick="showTab('pre')">📋 Pre-Training</button>
                <button class="tab-button" onclick="showTab('post')">✅ Post-Training</button>
            </div>
            
            <!-- Pre-Training Assessment -->
            <div id="pre-assessment" class="assessment-content active">
                <div class="assessment-header">
                    <div class="assessment-title">Pre-Training Assessment</div>
                    <div class="assessment-subtitle">How are you feeling before today's session?</div>
                </div>
                
                <!-- Progress Bar -->
                <div class="step-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="pre-progress" style="width: 33%;"></div>
                    </div>
                    <div class="progress-text">
                        <span id="pre-step-indicator">Step 1 of 3</span>
                        <span id="pre-step-category">Physical State</span>
                    </div>
                </div>
                
                <!-- Step 1: Physical State -->
                <div id="pre-step-1" class="form-section active">
                    <div class="form-group">
                        <label class="form-label">Overall Fatigue <span class="required">*</span></label>
                        <div class="form-description">How tired or fatigued do you feel right now?</div>
                        <div class="slider-container">
                            <div class="slider-value">
                                <span class="slider-value-display" id="fatigue-value">3</span>
                            </div>
                            <div class="slider-description" id="fatigue-desc">Moderate</div>
                            <input type="range" class="slider-input" min="1" max="5" value="3" id="fatigue-slider">
                            <div class="range-labels">
                                <span>Completely Rested</span>
                                <span>Extremely Fatigued</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Muscle Soreness / Tightness <span class="required">*</span></label>
                        <div class="form-description">How sore or tight are your muscles today?</div>
                        <div class="slider-container">
                            <div class="slider-value">
                                <span class="slider-value-display" id="soreness-value">3</span>
                            </div>
                            <div class="slider-description" id="soreness-desc">Moderate</div>
                            <input type="range" class="slider-input" min="1" max="5" value="3" id="soreness-slider">
                            <div class="range-labels">
                                <span>No Soreness</span>
                                <span>Very Sore/Tight</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Sleep Quality & Quantity <span class="required">*</span></label>
                        <div class="form-description">How would you rate your sleep last night?</div>
                        <div class="slider-container">
                            <div class="slider-value">
                                <span class="slider-value-display" id="sleep-value">3</span>
                            </div>
                            <div class="slider-description" id="sleep-desc">Okay</div>
                            <input type="range" class="slider-input" min="1" max="5" value="3" id="sleep-slider">
                            <div class="range-labels">
                                <span>Excellent/Restful</span>
                                <span>Very Poor/Disturbed</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Mental & Readiness -->
                <div id="pre-step-2" class="form-section">
                    <div class="form-group">
                        <label class="form-label">Stress / Mood <span class="required">*</span></label>
                        <div class="form-description">How stressed or mentally fatigued are you feeling?</div>
                        <div class="slider-container">
                            <div class="slider-value">
                                <span class="slider-value-display" id="stress-value">3</span>
                            </div>
                            <div class="slider-description" id="stress-desc">Moderate</div>
                            <input type="range" class="slider-input" min="1" max="5" value="3" id="stress-slider">
                            <div class="range-labels">
                                <span>Very Low Stress</span>
                                <span>Very High Stress</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Readiness to Train <span class="required">*</span></label>
                        <div class="form-description">How ready do you feel to perform at high intensity today?</div>
                        <div class="slider-container">
                            <div class="slider-value">
                                <span class="slider-value-display" id="readiness-value">3</span>
                            </div>
                            <div class="slider-description" id="readiness-desc">Moderate</div>
                            <input type="range" class="slider-input" min="1" max="5" value="3" id="readiness-slider">
                            <div class="range-labels">
                                <span>Not Ready At All</span>
                                <span>Fully Ready</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Additional Information -->
                <div id="pre-step-3" class="form-section">
                    <div class="form-group">
                        <label class="form-label">External Load - Last 72 Hours</label>
                        <div class="form-description">List any other physical activities (gym, 5-a-side, etc.)</div>
                        <input type="text" class="form-input" id="external-load" placeholder="e.g., 5-a-side Tuesday, gym Wednesday...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Body Area Discomfort</label>
                        <div class="form-description">Select any areas where you feel discomfort</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item" onclick="toggleBodyArea(this, 'neck')">Neck</div>
                            <div class="checkbox-item" onclick="toggleBodyArea(this, 'shoulders')">Shoulders</div>
                            <div class="checkbox-item" onclick="toggleBodyArea(this, 'back')">Back</div>
                            <div class="checkbox-item" onclick="toggleBodyArea(this, 'hips')">Hips</div>
                            <div class="checkbox-item" onclick="toggleBodyArea(this, 'hamstrings')">Hamstrings</div>
                            <div class="checkbox-item" onclick="toggleBodyArea(this, 'quads')">Quads</div>
                            <div class="checkbox-item" onclick="toggleBodyArea(this, 'calves')">Calves</div>
                            <div class="checkbox-item" onclick="toggleBodyArea(this, 'ankles')">Ankles</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Coach Notes</label>
                        <div class="form-description">Anything we should know before today's session?</div>
                        <input type="text" class="form-input" id="coach-notes" placeholder="Minor knocks, heavy week, illness, etc...">
                    </div>
                </div>
            </div>
            
            <!-- Post-Training Assessment -->
            <div id="post-assessment" class="assessment-content">
                <div class="assessment-header">
                    <div class="assessment-title">Post-Training Assessment</div>
                    <div class="assessment-subtitle">How did today's training session go?</div>
                </div>
                
                <div class="form-section active">
                    <div class="form-group">
                        <label class="form-label">Session Type <span class="required">*</span></label>
                        <div class="form-description">What type of session was this?</div>
                        <select class="form-select" id="session-type">
                            <option value="">Select session type...</option>
                            <option value="match">Match</option>
                            <option value="pitch_training">Pitch/Training</option>
                            <option value="gym">Gym Session</option>
                            <option value="conditioning">Conditioning</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Training Duration (minutes) <span class="required">*</span></label>
                        <div class="form-description">How long was the session?</div>
                        <input type="number" class="form-input" id="session-duration" placeholder="e.g., 90" min="1" max="300">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Intensity Scale - RPE (1-10) <span class="required">*</span></label>
                        <div class="form-description">Rate of Perceived Exertion - How hard did the session feel?</div>
                        <div class="slider-container">
                            <div class="slider-value">
                                <span class="slider-value-display" id="rpe-value">5</span>
                            </div>
                            <div class="slider-description" id="rpe-desc">Moderate</div>
                            <input type="range" class="slider-input" min="1" max="10" value="5" id="rpe-slider">
                            <div class="range-labels">
                                <span>1 - Very Light</span>
                                <span>10 - Maximum</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Post-Session Muscle Soreness <span class="required">*</span></label>
                        <div class="form-description">Overall muscle soreness level after the session</div>
                        <div class="slider-container">
                            <div class="slider-value">
                                <span class="slider-value-display" id="post-soreness-value">1</span>
                            </div>
                            <div class="slider-description" id="post-soreness-desc">None</div>
                            <input type="range" class="slider-input" min="1" max="4" value="1" id="post-soreness-slider">
                            <div class="range-labels">
                                <span>None</span>
                                <span>Severe</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Session Notes (Optional)</label>
                        <div class="form-description">Any additional comments about the session?</div>
                        <input type="text" class="form-input" id="session-notes" placeholder="Great session, felt strong throughout...">
                    </div>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="fab-container">
                <button class="nav-button secondary" id="pre-prev-btn" onclick="prevPreStep()">Previous</button>
                <button class="nav-button primary show" id="pre-next-btn" onclick="nextPreStep()">Next</button>
                <button class="nav-button success" id="pre-submit-btn" onclick="submitPreAssessment()">Submit Assessment</button>
                <button class="nav-button success" id="post-submit-btn" onclick="submitPostAssessment()">Complete Assessment</button>
            </div>
        </div>
    </div>
    
    <script>
        // App configuration
        const API_BASE ='https://traintracksc.vercel.app/api/api';
        
        // App state
        let currentUser = null;
        let sessionToken = null;
        let currentTab = 'pre';
        let preStepCurrent = 1;
        const preStepTotal = 3;
        let selectedBodyAreas = [];
        
        // Slider descriptions
        const sliderDescriptions = {
            fatigue: ['Completely Rested', 'Slightly Tired', 'Moderate', 'High Fatigue', 'Extremely Fatigued'],
            soreness: ['No Soreness', 'Slight Soreness', 'Moderate', 'High Soreness', 'Very Sore/Tight'],
            sleep: ['Excellent/Restful', 'Good Sleep', 'Okay', 'Poor Sleep', 'Very Poor/Disturbed'],
            stress: ['Very Low Stress', 'Low Stress', 'Moderate', 'High Stress', 'Very High Stress'],
            readiness: ['Not Ready At All', 'Low Readiness', 'Moderate', 'Ready', 'Fully Ready'],
            rpe: ['Very Light', 'Light', 'Light+', 'Moderate', 'Moderate+', 'Hard', 'Hard+', 'Very Hard', 'Very Hard+', 'Maximum'],
            postSoreness: ['None', 'Mild', 'Moderate', 'Severe']
        };
        
        const stepCategories = ['Physical State', 'Mental & Readiness', 'Additional Information'];
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        async function initializeApp() {
            // Check for existing session
            const storedToken = localStorage.getItem('sessionToken');
            const storedUser = localStorage.getItem('currentUser');
            
            if (storedToken && storedUser) {
                try {
                    sessionToken = storedToken;
                    currentUser = JSON.parse(storedUser);
                    
                    // Validate session with server
                    const profile = await apiRequest('/auth/profile', {
                        method: 'GET'
                    });
                    
                    showAssessmentApp();
                    await loadUserData();
                } catch (error) {
                    console.error('Session validation failed:', error);
                    clearSession();
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }
            
            setupEventListeners();
            initializeSliders();
        }
        
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout button
            document.querySelector('.logout-btn').addEventListener('click', logout);
        }
        
        function initializeSliders() {
            initializeSlider('fatigue', 'fatigue');
            initializeSlider('soreness', 'soreness');
            initializeSlider('sleep', 'sleep');
            initializeSlider('stress', 'stress');
            initializeSlider('readiness', 'readiness');
            initializeSlider('rpe', 'rpe');
            initializeSlider('post-soreness', 'postSoreness');
            updatePreProgress();
        }
        
        function initializeSlider(sliderId, descriptionKey) {
            const slider = document.getElementById(sliderId + '-slider');
            const valueDisplay = document.getElementById(sliderId + '-value');
            const descDisplay = document.getElementById(sliderId + '-desc');
            
            if (slider && valueDisplay && descDisplay) {
                slider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    valueDisplay.textContent = value;
                    descDisplay.textContent = sliderDescriptions[descriptionKey][value - 1];
                });
                
                // Set initial values
                const value = parseInt(slider.value);
                valueDisplay.textContent = value;
                descDisplay.textContent = sliderDescriptions[descriptionKey][value - 1];
            }
        }
        
        // Authentication functions
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showLoading();
            hideMessages();
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        deviceInfo: getDeviceInfo()
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    sessionToken = data.sessionToken;
                    currentUser = data.user;
                    
                    // Store session
                    localStorage.setItem('sessionToken', sessionToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showMessage('loginSuccess', 'Welcome back! Loading your dashboard...', 'success');
                    
                    setTimeout(async () => {
                        showAssessmentApp();
                        await loadUserData();
                    }, 1500);
                } else {
                    showMessage('loginError', data.error || 'Login failed. Please check your credentials.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('loginError', 'Network error. Please check your connection and try again.', 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    await apiRequest('/auth/logout', {
                        method: 'POST'
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
                
                clearSession();
                showLoginScreen();
            }
        }
        
        function clearSession() {
            localStorage.removeItem('sessionToken');
            localStorage.removeItem('currentUser');
            sessionToken = null;
            currentUser = null;
        }
        
        // API helper
        async function apiRequest(endpoint, options = {}) {
            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            
            if (sessionToken) {
                config.headers['Authorization'] = `Bearer ${sessionToken}`;
            }
            
            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (response.status === 401) {
                clearSession();
                showLoginScreen();
                throw new Error('Session expired');
            }
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Request failed with status ${response.status}`);
            }
            
            return response.json();
        }
        
        // UI functions
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('assessmentApp').style.display = 'none';
        }
        
        function showAssessmentApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('assessmentApp').style.display = 'block';
        }
        
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showMessage(elementId, message, type = 'error') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        element.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        function hideMessages() {
            document.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.style.display = 'none';
            });
        }
        
        function getDeviceInfo() {
            return {
                type: /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
                name: navigator.userAgent.includes('iPhone') ? 'iPhone' : 
                      navigator.userAgent.includes('Android') ? 'Android' : 'Browser',
                fingerprint: `${navigator.userAgent}-${screen.width}x${screen.height}-${Date.now()}`
            };
        }
        
        // Load user data
        async function loadUserData() {
            try {
                const profile = await apiRequest('/auth/profile');
                
                // Update athlete name
                const athleteName = `${profile.user.firstName} ${profile.user.lastName}`;
                document.getElementById('athleteName').textContent = athleteName;
                
                // Update team info
                if (profile.teams && profile.teams.length > 0) {
                    const team = profile.teams[0];
                    const today = new Date().toLocaleDateString('en-IE', { 
                        weekday: 'long', 
                        month: 'long', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                    document.getElementById('teamInfo').textContent = `${team.sport} • ${today}`;
                } else {
                    const today = new Date().toLocaleDateString('en-IE', { 
                        weekday: 'long', 
                        month: 'long', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                    document.getElementById('teamInfo').textContent = `Training • ${today}`;
                }
                
                // TODO: Load assessment history and update last assessment, weekly sessions
                document.getElementById('lastAssessment').textContent = '2 hours ago';
                document.getElementById('weeklySessions').textContent = '4/5';
                
            } catch (error) {
                console.error('Failed to load user data:', error);
                // Use basic user data
                if (currentUser) {
                    document.getElementById('athleteName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                    const today = new Date().toLocaleDateString('en-IE', { 
                        weekday: 'long', 
                        month: 'long', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                    document.getElementById('teamInfo').textContent = `Training • ${today}`;
                }
            }
        }
        
        // Tab switching
        function showTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.assessment-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-assessment').classList.add('active');
            
            currentTab = tab;
            updateNavigationButtons();
        }
        
        // Pre-training step navigation
        function updatePreProgress() {
            const progressPercentage = (preStepCurrent / preStepTotal) * 100;
            const progressFill = document.getElementById('pre-progress');
            const stepIndicator = document.getElementById('pre-step-indicator');
            const stepCategory = document.getElementById('pre-step-category');
            
            if (progressFill) progressFill.style.width = progressPercentage + '%';
            if (stepIndicator) stepIndicator.textContent = `Step ${preStepCurrent} of ${preStepTotal}`;
            if (stepCategory) stepCategory.textContent = stepCategories[preStepCurrent - 1];
            
            updateNavigationButtons();
        }
        
        function updateNavigationButtons() {
            // Hide all buttons first
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('show'));
            
            if (currentTab === 'pre') {
                const prevBtn = document.getElementById('pre-prev-btn');
                const nextBtn = document.getElementById('pre-next-btn');
                const submitBtn = document.getElementById('pre-submit-btn');
                
                if (preStepCurrent > 1) {
                    prevBtn.classList.add('show');
                }
                
                if (preStepCurrent < preStepTotal) {
                    nextBtn.classList.add('show');
                } else {
                    submitBtn.classList.add('show');
                }
            } else if (currentTab === 'post') {
                document.getElementById('post-submit-btn').classList.add('show');
            }
        }
        
        function nextPreStep() {
            if (preStepCurrent < preStepTotal) {
                // Hide current step
                document.getElementById(`pre-step-${preStepCurrent}`).classList.remove('active');
                
                // Show next step
                preStepCurrent++;
                document.getElementById(`pre-step-${preStepCurrent}`).classList.add('active');
                
                updatePreProgress();
                window.scrollTo(0, 0);
            }
        }
        
        function prevPreStep() {
            if (preStepCurrent > 1) {
                // Hide current step
                document.getElementById(`pre-step-${preStepCurrent}`).classList.remove('active');
                
                // Show previous step
                preStepCurrent--;
                document.getElementById(`pre-step-${preStepCurrent}`).classList.add('active');
                
                updatePreProgress();
                window.scrollTo(0, 0);
            }
        }
        
        // Body area selection
        function toggleBodyArea(element, area) {
            if (selectedBodyAreas.includes(area)) {
                selectedBodyAreas = selectedBodyAreas.filter(a => a !== area);
                element.classList.remove('selected');
            } else {
                selectedBodyAreas.push(area);
                element.classList.add('selected');
            }
        }
        
        // Form submissions
        async function submitPreAssessment() {
            showLoading();
            
            try {
                const formData = {
                    fatigue: document.getElementById('fatigue-slider').value,
                    soreness: document.getElementById('soreness-slider').value,
                    sleep: document.getElementById('sleep-slider').value,
                    stress: document.getElementById('stress-slider').value,
                    readiness: document.getElementById('readiness-slider').value,
                    externalLoad: document.getElementById('external-load').value || null,
                    bodyAreas: selectedBodyAreas,
                    coachNotes: document.getElementById('coach-notes').value || null,
                    offline: !navigator.onLine
                };
                
                const result = await apiRequest('/assessments/pre-training', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                alert('✅ Pre-training assessment submitted successfully!\n\nYour readiness data has been recorded.');
                
                // Reset form
                resetPreForm();
                
            } catch (error) {
                console.error('Pre-training submission error:', error);
                alert('❌ Failed to submit assessment. Please check your connection and try again.');
            } finally {
                hideLoading();
            }
        }
        
        async function submitPostAssessment() {
            // Validate required fields
            const sessionType = document.getElementById('session-type').value;
            const duration = document.getElementById('session-duration').value;
            
            if (!sessionType || !duration) {
                alert('Please fill in all required fields (Session Type and Duration).');
                return;
            }
            
            showLoading();
            
            try {
                const formData = {
                    sessionType: sessionType,
                    duration: duration,
                    rpe: document.getElementById('rpe-slider').value,
                    postSoreness: document.getElementById('post-soreness-slider').value,
                    sessionNotes: document.getElementById('session-notes').value || null,
                    offline: !navigator.onLine
                };
                
                const result = await apiRequest('/assessments/post-training', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                alert('✅ Post-training assessment completed!\n\nYour session data has been recorded.');
                
                // Reset form
                resetPostForm();
                
            } catch (error) {
                console.error('Post-training submission error:', error);
                alert('❌ Failed to submit assessment. Please check your connection and try again.');
            } finally {
                hideLoading();
            }
        }
        
        function resetPreForm() {
            // Reset sliders to default values
            document.getElementById('fatigue-slider').value = 3;
            document.getElementById('soreness-slider').value = 3;
            document.getElementById('sleep-slider').value = 3;
            document.getElementById('stress-slider').value = 3;
            document.getElementById('readiness-slider').value = 3;
            
            // Reset text inputs
            document.getElementById('external-load').value = '';
            document.getElementById('coach-notes').value = '';
            
            // Reset body areas
            selectedBodyAreas = [];
            document.querySelectorAll('.checkbox-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Reset steps
            preStepCurrent = 1;
            document.querySelectorAll('.form-section').forEach((section, index) => {
                section.classList.toggle('active', index === 0);
            });
            
            // Reinitialize sliders
            initializeSliders();
        }
        
        function resetPostForm() {
            // Reset form elements
            document.getElementById('session-type').value = '';
            document.getElementById('session-duration').value = '';
            document.getElementById('rpe-slider').value = 5;
            document.getElementById('post-soreness-slider').value = 1;
            document.getElementById('session-notes').value = '';
            
            // Reinitialize sliders
            initializeSliders();
        }
        
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    <script src="src/js/config.js"></script> 
</body>
</html>
